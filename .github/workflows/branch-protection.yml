name: Branch Protection Setup

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'setup'
        type: choice
        options:
        - setup
        - update
        - disable

jobs:
  setup-branch-protection:
    name: Configure Branch Protection Rules
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'disable'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Branch Protection Rules
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            // Main branch protection
            const mainProtectionConfig = {
              required_status_checks: {
                strict: true,
                contexts: [
                  'SonarQube Code Analysis',
                  'Quality Gate Check'
                ]
              },
              enforce_admins: true,
              required_pull_request_reviews: {
                required_approving_review_count: 2,
                dismiss_stale_reviews: true,
                require_code_owner_reviews: true,
                require_last_push_approval: true
              },
              restrictions: null,
              block_creations: false
            };

            // Development branch protection (less strict)
            const developProtectionConfig = {
              required_status_checks: {
                strict: true,
                contexts: [
                  'SonarQube Code Analysis'
                ]
              },
              enforce_admins: false,
              required_pull_request_reviews: {
                required_approving_review_count: 1,
                dismiss_stale_reviews: true,
                require_code_owner_reviews: false,
                require_last_push_approval: false
              },
              restrictions: null,
              block_creations: false
            };

            try {
              // Configure main branch protection
              console.log('Setting up protection for main branch...');
              await github.rest.repos.updateBranchProtection({
                owner,
                repo,
                branch: 'main',
                ...mainProtectionConfig
              });
              console.log('✅ Main branch protection configured');

              // Configure develop branch protection
              console.log('Setting up protection for develop branch...');
              await github.rest.repos.updateBranchProtection({
                owner,
                repo,
                branch: 'develop',
                ...developProtectionConfig
              });
              console.log('✅ Develop branch protection configured');

            } catch (error) {
              console.error('Error setting up branch protection:', error);
              core.setFailed(`Failed to configure branch protection: ${error.message}`);
            }

  disable-branch-protection:
    name: Disable Branch Protection Rules
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'disable'

    steps:
      - name: Disable Branch Protection
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            try {
              // Disable protection for main branch
              await github.rest.repos.deleteBranchProtection({
                owner,
                repo,
                branch: 'main'
              });
              console.log('✅ Main branch protection disabled');

              // Disable protection for develop branch
              await github.rest.repos.deleteBranchProtection({
                owner,
                repo,
                branch: 'develop'
              });
              console.log('✅ Develop branch protection disabled');

            } catch (error) {
              console.log('Note: Some protections might not exist:', error.message);
            }